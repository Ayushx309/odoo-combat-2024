<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Paper</title>
    <link rel="stylesheet" href="{{url_for('static',filename='css/dashboard/uploadCommon.css')}}">
    <link rel="stylesheet" href="{{url_for('static',filename='css/dashboard/uploadForm.css')}}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale-subtle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';
    </script>
    <!-- Add Tagify CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
    {% include "Dashboard/mainStyles.html" %}
</head>

<body>
    {% include "Dashboard/mainPartOne.html" %}
    <!-- Form Title -->
    <div class="page-title-container">
        <span class="page-title">Upload new paper</span>
    </div>
    <!-- Form Title -->
    <!-- Main Content -->
    <div class="main-container">
        <div class="tab-menu-container">
            <a href="#" class="tab_menu_btn active_tab">Upload Paper</a>
        </div>
        <div class="content-container">
            <form class="form-container" method="post" enctype="multipart/form-data">
                <!-- Category -->
                <div class="form-category-container">
                    <span class="form-category-title">Paper Details</span>
                    <div class="form-category-input-container">

                        <div class="form-category-input">
                            <span class="form-input-label">Name <span class="form-input-required-icon">*</span></span>
                            <div class="form-input-styling" id="username-styling">
                                <input type="text" name="paper_name" class="form_input" autocomplete="off" required />
                            </div>
                        </div>
                        <div class="form-category-input">
                            <span class="form-input-label">Description <span
                                    class="form-input-required-icon">*</span></span>
                            <div class="form-input-styling">
                                <textarea type="text" name="paper_desc" class="form_input form_textarea"
                                    required></textarea>
                            </div>
                        </div>
                        <div class="form-category-input">
                            <span class="form-input-label">Schedule Time <span
                                    class="form-input-required-icon">*</span></span>
                            <div class="form-input-styling">
                                <input type="text" id="datetimepicker" name="paper_stime" class="form_input"
                                    autocomplete="off" required placeholder="Click Here To Select Schedule Time" />
                            </div>
                        </div>
                        <div class="form-category-input">
                            <span class="form-input-label">Expiry Time <span
                                    class="form-input-required-icon">*</span></span>
                            <div class="form-input-styling">
                                <input type="text" id="datetimepicker2" name="paper_etime" class="form_input"
                                    autocomplete="off" required placeholder="Click Here To Select Expiry Time" />
                            </div>
                        </div>
                    </div>

                    <div class="form-category-input">
                        <span class="form-input-label">Access Control <span
                                class="form-input-required-icon">*</span></span>
                        <div class="form-input-styling" id="username-styling">
                            <input name='tags' placeholder='write some tags' class="form_input" id="tagsID">
                        </div>
                    </div>

                </div>
                <!-- Category -->
                <div class="form-category-container form-upload-category">
                    <span class="form-category-title">Project Documents Upload</span>
                    <div class="form-category-input-container">
                        <div class="form-category-input">
                            <div class="form-input-label-container">
                                <span class="form-input-label">Paper PDF</span>
                            </div>
                            <div class="form-input-styling">
                                <input type="file" name="paper_pdf" class="form_input" id="file_paper" required/>
                            </div>
                            <button type="button" class="btn viewPdfButton" data-target="paper"
                                style="display: none;">View Uploaded PDF</button>
                        </div>



                        <div class="modal" id="pdfModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="pdfModalLabel">PDF Preview</h5>
                                    <span class="close" id="closeModal">&times;</span>
                                </div>
                                <div class="modal-body">
                                    <div id="pdfControls">
                                        <button id="prevPage" class="btn btn-secondary" type="button">Previous</button>
                                        <span>Page: <span id="pageNum">1</span> / <span id="pageCount">1</span></span>
                                        <button id="nextPage" class="btn btn-secondary" type="button">Next</button>
                                    </div>
                                    <canvas id="pdfCanvas"></canvas>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" id="closeFooterModal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="form-create-input">
                    <input type="submit" name="Create" id="create" value="Create" class="form-btn" />
                </div>
            </form>
        </div>
    </div>

    </div>

    <!-- Main Content -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {% include "Dashboard/mainPartTwo.html" %}
    {% if message %}
    {{ message | safe }}
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script>
        window.onload = function () {
            function addActiveClassToAnchor(id) {
                var anchor = document.getElementById(id);
                if (anchor) {
                    anchor.classList.add('active');
                } else {
                    console.error("Anchor with ID '" + id + "' not found.");
                }
            }
            addActiveClassToAnchor('upload_active');
        };

        // sweetalert

        document.addEventListener('DOMContentLoaded', (event) => {
            let formFields = document.querySelectorAll('.form_input');
            let formChanged = false;
            let formSubmitted = false;

            formFields.forEach((field) => {
                field.addEventListener('input', () => {
                    formChanged = true;
                });
            });

            window.addEventListener('beforeunload', (e) => {
                if (formChanged && !formSubmitted) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            document.querySelector('form').addEventListener('submit', (e) => {
                if (!formSubmitted) {
                    e.preventDefault();
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "Do you really want to upload a paper?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, upload',
                        cancelButtonText: 'No, cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formSubmitted = true;
                            e.target.submit();
                        }
                    });
                }
            });

            document.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    if (formChanged && !formSubmitted) {
                        e.preventDefault();
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You have unsaved changes. Do you really want to leave?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, leave',
                            cancelButtonText: 'No, stay'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.removeEventListener('beforeunload', () => { });
                                window.location.href = e.target.href;
                            }
                        });
                    }
                });
            });

            window.addEventListener('popstate', (e) => {
                if (formChanged && !formSubmitted) {
                    e.preventDefault();
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "You have unsaved changes. Do you really want to leave?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, leave',
                        cancelButtonText: 'No, stay'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.removeEventListener('beforeunload', () => { });
                            window.location.href = e.state ? e.state.url : window.location.href;
                        }
                    });
                }
            });
        });


    </script>
    <script>
        $(document).ready(function () {
            $('#user_name').on('change', function () {
                var username = $(this).val();

                $.ajax({
                    url: '/api/checkUsernameAvailability',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ username: username }),
                    success: function (response) {
                        if (response.exists) {
                            $('#username-styling').attr('style', 'border: 2px solid red');
                            $('#create').prop('disabled', true);
                            iziToast.warning({
                                title: 'Warning',
                                message: `Username '${username}' not available`,
                                position: 'topRight',
                            });

                        } else if (username === "") {

                        }
                        else {
                            $('#username-styling').attr('style', 'border: 2px solid green');
                            $('#create').prop('disabled', false);
                        }
                    },
                    error: function (error) {
                        $('#result').text('Error checking user');
                    }
                });
            });
        });
    </script>
    <script type="text/javascript">
        flatpickr("#datetimepicker", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
        });
        flatpickr("#datetimepicker2", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
        });
    </script>

    <!-- PDF Preview -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var $j = jQuery.noConflict();

        $j(document).ready(function () {
            var pdfDoc = null,
                pageNum = 1,
                pageRendering = false,
                pageNumPending = null,
                scale = 1.5,
                canvas = document.getElementById('pdfCanvas'),
                ctx = canvas.getContext('2d');

            function renderPage(num) {
                pageRendering = true;
                pdfDoc.getPage(num).then(function (page) {
                    var viewport = page.getViewport({ scale: scale });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    var renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };

                    var renderTask = page.render(renderContext);

                    renderTask.promise.then(function () {
                        pageRendering = false;

                        if (pageNumPending !== null) {
                            renderPage(pageNumPending);
                            pageNumPending = null;
                        }
                    });
                });

                document.getElementById('pageNum').textContent = num;
            }

            function queueRenderPage(num) {
                if (pageRendering) {
                    pageNumPending = num;
                } else {
                    renderPage(num);
                }
            }

            function onPrevPage() {
                if (pageNum <= 1) {
                    return;
                }
                pageNum--;
                queueRenderPage(pageNum);
            }

            function onNextPage() {
                if (pageNum >= pdfDoc.numPages) {
                    return;
                }
                pageNum++;
                queueRenderPage(pageNum);
            }

            $j('#prevPage').on('click', onPrevPage);
            $j('#nextPage').on('click', onNextPage);

            $j('.viewPdfButton').on('click', function () {
                $j('body').css('overflow', 'hidden');
                var fileType = $j(this).data('target');
                var fileInput = document.getElementById('file_paper');
                var file = fileInput.files[0];
                if (file && file.type === 'application/pdf') {
                    var fileURL = URL.createObjectURL(file);
                    pageNum = 1;
                    pageNumPending = null;
                    showPDF(fileURL);
                } else {
                    alert('Please upload a valid PDF file.');
                }
            });

            function showPDF(pdf_url) {
                pdfjsLib.getDocument(pdf_url).promise.then(function (pdfDoc_) {
                    pdfDoc = pdfDoc_;
                    document.getElementById('pageCount').textContent = pdfDoc.numPages;
                    renderPage(pageNum);
                    document.getElementById('pdfModal').style.display = 'block';
                });
            }

            function closeModal() {
                document.getElementById('pdfModal').style.display = 'none';
                $j('body').css('overflow', '');
            }

            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('closeFooterModal').addEventListener('click', closeModal);

            function checkFileSize(inputId) {
                var input = document.getElementById(inputId);
                var file = input.files[0];
                if (file.type !== 'application/pdf') {
                    iziToast.error({
                        title: 'Error',
                        message: 'Invalid file type. Please upload a PDF file.',
                        position: 'topRight',
                    });
                    event.target.value = '';
                    button.hide();
                    return;
                }
                var button = $j('.viewPdfButton[data-target="paper"]')
                button.show();
            }
            document.getElementById('file_paper').addEventListener('change', function (event) {
                checkFileSize('file_paper');
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>

    <script>
        $(document).ready(function () {
            // Initialize an empty array to store tag IDs
            var selectedTagIds = [];

            // Fetch account data from the server using POST request
            $.ajax({
                url: '/api/accounts', // Endpoint for fetching accounts
                method: 'POST',
                success: function (response) {
                    // Assuming the response is structured as {'accounts': [...] }
                    var whitelistData = response.accounts.map(function (account) {
                        return { value: account.username, id: account.id };
                    });

                    // Initialize Tagify script on the input
                    var input = document.querySelector('input[name=tags]'),
                        tagify = new Tagify(input, {
                            whitelist: whitelistData,
                            enforceWhitelist: true,
                            blacklist: ["fuck", "shit"],
                            templates: {
                                tag: function (tagData) {
                                    return `<tag title="${tagData.value}" contenteditable='false' spellcheck="false" tabIndex="-1" class="tagify__tag" tag-id="${tagData.id}">
                                        <x title='' class="tagify__tag__removeBtn"></x>
                                        <div>
                                            <span class="tagify__tag-text">${tagData.value}</span>
                                        </div>
                                    </tag>`;
                                }
                            },
                            transformTag: function (tagData) {
                                // Add the tag ID to the selectedTagIds array
                                selectedTagIds.push(tagData.id);
                                // Update the input value with the current selectedTagIds array
                                input.value = JSON.stringify(selectedTagIds);
                                return tagData.value; // Display username as the tag text
                            }
                        });

                    // Add existing tags if any are present
                    // tagify.addTags(whitelistData.map(tag => tag.value));

                },
                error: function (error) {
                    console.error('Error fetching account data:', error);
                }
            });

          
            var initialValue = $('input[name=tags]').val();
            if (initialValue) {
                selectedTagIds = JSON.parse(initialValue); // Restore selected tag IDs
            }

          
            // $('#exampleForm').on('submit', function (event) {
            //     var tagifyInput = document.querySelector('input[name=tags]').value;
            //     if (!tagifyInput) {
            //         event.preventDefault();
            //         alert('Please select at least one tag.');
            //     }
            // });
        });
    </script>

    <!-- <script>var input1 = document.querySelector('input[name=tags]'),
            input2 = document.querySelector('textarea[name=tags2]'),
            // init Tagify script on the above inputs
            tagify1 = new Tagify(input1, {
                whitelist: ["A# .NET", "A# (Axiom)", "A-0 System", "A+", "A++", "ABAP", "ABC", "ABC ALGOL", "ABSET", "ABSYS", "ACC", "Accent", "Ace DASL", "ACL2", "Avicsoft", "ACT-III", "Action!", "ActionScript", "Ada", "Adenine", "Agda", "Agilent VEE", "Agora", "AIMMS", "Alef", "ALF", "ALGOL 58", "ALGOL 60", "ALGOL 68", "ALGOL W", "Alice", "Alma-0", "AmbientTalk", "Amiga E", "AMOS", "AMPL", "Apex (Salesforce.com)", "APL", "AppleScript", "Arc", "ARexx", "Argus", "AspectJ", "Assembly language", "ATS", "Ateji PX", "AutoHotkey", "Autocoder", "AutoIt", "AutoLISP / Visual LISP", "Averest", "AWK", "Axum", "Active Server Pages", "ASP.NET", "B", "Babbage", "Bash", "BASIC", "bc", "BCPL", "BeanShell", "Batch (Windows/Dos)", "Bertrand", "BETA", "Bigwig", "Bistro", "BitC", "BLISS", "Blockly", "BlooP", "Blue", "Boo", "Boomerang", "Bourne shell (including bash and ksh)", "BREW", "BPEL", "B", "C--", "C++ – ISO/IEC 14882", "C# – ISO/IEC 23270", "C/AL", "Caché ObjectScript", "C Shell", "Caml", "Cayenne", "CDuce", "Cecil", "Cesil", "Céu", "Ceylon", "CFEngine", "CFML", "Cg", "Ch", "Chapel", "Charity", "Charm", "Chef", "CHILL", "CHIP-8", "chomski", "ChucK", "CICS", "Cilk", "Citrine (programming language)", "CL (IBM)", "Claire", "Clarion", "Clean", "Clipper", "CLIPS", "CLIST", "Clojure", "CLU", "CMS-2", "COBOL – ISO/IEC 1989", "CobolScript – COBOL Scripting language", "Cobra", "CODE", "CoffeeScript", "ColdFusion", "COMAL", "Combined Programming Language (CPL)", "COMIT", "Common Intermediate Language (CIL)", "Common Lisp (also known as CL)", "COMPASS", "Component Pascal", "Constraint Handling Rules (CHR)", "COMTRAN", "Converge", "Cool", "Coq", "Coral 66", "Corn", "CorVision", "COWSEL", "CPL", "CPL", "Cryptol", "csh", "Csound", "CSP", "CUDA", "Curl", "Curry", "Cybil", "Cyclone", "Cython", "M2001", "M4", "M#", "Machine code", "MAD (Michigan Algorithm Decoder)", "MAD/I", "Magik", "Magma", "make", "Maple", "MAPPER now part of BIS", "MARK-IV now VISION:BUILDER", "Mary", "MASM Microsoft Assembly x86", "MATH-MATIC", "Mathematica", "MATLAB", "Maxima (see also Macsyma)", "Max (Max Msp – Graphical Programming Environment)", "MaxScript internal language 3D Studio Max", "Maya (MEL)", "MDL", "Mercury", "Mesa", "Metafont", "Microcode", "MicroScript", "MIIS", "Milk (programming language)", "MIMIC", "Mirah", "Miranda", "MIVA Script", "ML", "Model 204", "Modelica", "Modula", "Modula-2", "Modula-3", "Mohol", "MOO", "Mortran", "Mouse", "MPD", "Mathcad", "MSIL – deprecated name for CIL", "MSL", "MUMPS", "Mystic Programming L"],
                blacklist: ["fuck", "shit"]
            });

        // toggle Tagify on/off
        document.querySelector('input[type=checkbox]').addEventListener('change', function () {
            document.body.classList[this.checked ? 'add' : 'remove']('disabled');
        })
    </script> -->
</body>

</html>