<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Paper</title>
    <link rel="stylesheet" href="{{url_for('static',filename='css/dashboard/uploadCommon.css')}}">
    <link rel="stylesheet" href="{{url_for('static',filename='css/dashboard/uploadForm.css')}}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale-subtle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';
    </script>
    {% include "Dashboard/mainStyles.html" %}
</head>

<body>
    {% include "Dashboard/mainPartOne.html" %}
    <!-- Form Title -->
    <div class="page-title-container">
        <span class="page-title">Upload new paper</span>
    </div>
    <!-- Form Title -->
    <!-- Main Content -->
    <div class="main-container">
        <div class="tab-menu-container">
            <a href="#" class="tab_menu_btn active_tab">Upload Paper</a>
        </div>
        <div class="content-container">
            <form class="form-container" method="post">
                <!-- Category -->
                <div class="form-category-container">
                    <span class="form-category-title">Paper Details</span>
                    <div class="form-category-input-container">

                        <div class="form-category-input">
                            <span class="form-input-label">Name <span
                                class="form-input-required-icon">*</span></span>
                            <div class="form-input-styling" id="username-styling">
                                <input type="text" name="paper_name" class="form_input" autocomplete="off"
                                    required />
                            </div>
                        </div>
                        <div class="form-category-input">
                            <span class="form-input-label">Description <span
                                    class="form-input-required-icon">*</span></span>
                            <div class="form-input-styling">
                                <textarea type="text" name="paper_desc" class="form_input form_textarea"
                                    required></textarea>
                            </div>
                        </div>
                        <div class="form-category-input">
                            <span class="form-input-label">Schedule Time <span
                                class="form-input-required-icon">*</span></span>
                            <div class="form-input-styling">
                                <input type="text" id="datetimepicker" name="paper_stime" class="form_input" autocomplete="off"
                                    required placeholder="Click Here To Select Schedule Time" />
                            </div>
                        </div>
                        <div class="form-category-input">
                            <span class="form-input-label">Expiry Time <span
                                class="form-input-required-icon">*</span></span>
                            <div class="form-input-styling">
                                <input type="text" id="datetimepicker" name="paper_etime" class="form_input" autocomplete="off"
                                    required placeholder="Click Here To Select Expiry Time" />
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Category -->
                <div class="form-category-container form-upload-category">
                    <span class="form-category-title">Project Documents Upload</span>
                    <div class="form-category-input-container">
                        <div class="form-category-input">
                            <div class="form-input-label-container">
                                <span class="form-input-label">Paper PDF</span>
                            </div>
                            <div class="form-input-styling">
                                <input type="file" name="paper_pdf" class="form_input" id="file_paper" />
                            </div>
                            <button type="button" class="btn viewPdfButton" data-target="paper"
                                style="display: none;">View Uploaded PDF</button>
                        </div>



                        <div class="modal" id="pdfModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="pdfModalLabel">PDF Preview</h5>
                                    <span class="close" id="closeModal">&times;</span>
                                </div>
                                <div class="modal-body">
                                    <div id="pdfControls">
                                        <button id="prevPage" class="btn btn-secondary" type="button">Previous</button>
                                        <span>Page: <span id="pageNum">1</span> / <span id="pageCount">1</span></span>
                                        <button id="nextPage" class="btn btn-secondary" type="button">Next</button>
                                    </div>
                                    <canvas id="pdfCanvas"></canvas>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" id="closeFooterModal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="form-create-input">
                    <input type="submit" name="Create" id="create" value="Create" class="form-btn" />
                </div>
            </form>
        </div>
    </div>

    </div>

    <!-- Main Content -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {% include "Dashboard/mainPartTwo.html" %}
    {% if message %}
    {{ message | safe }}
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script>
        window.onload = function () {
            function addActiveClassToAnchor(id) {
                var anchor = document.getElementById(id);
                if (anchor) {
                    anchor.classList.add('active');
                } else {
                    console.error("Anchor with ID '" + id + "' not found.");
                }
            }
            addActiveClassToAnchor('upload_active');
        };

        // sweetalert

        document.addEventListener('DOMContentLoaded', (event) => {
            let formFields = document.querySelectorAll('.form_input');
            let formChanged = false;
            let formSubmitted = false;

            formFields.forEach((field) => {
                field.addEventListener('input', () => {
                    formChanged = true;
                });
            });

            window.addEventListener('beforeunload', (e) => {
                if (formChanged && !formSubmitted) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            document.querySelector('form').addEventListener('submit', (e) => {
                if (!formSubmitted) {
                    e.preventDefault();
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "Do you really want to create an account?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, create',
                        cancelButtonText: 'No, cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formSubmitted = true;
                            e.target.submit();
                        }
                    });
                }
            });

            document.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    if (formChanged && !formSubmitted) {
                        e.preventDefault();
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You have unsaved changes. Do you really want to leave?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, leave',
                            cancelButtonText: 'No, stay'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.removeEventListener('beforeunload', () => { });
                                window.location.href = e.target.href;
                            }
                        });
                    }
                });
            });

            window.addEventListener('popstate', (e) => {
                if (formChanged && !formSubmitted) {
                    e.preventDefault();
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "You have unsaved changes. Do you really want to leave?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, leave',
                        cancelButtonText: 'No, stay'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.removeEventListener('beforeunload', () => { });
                            window.location.href = e.state ? e.state.url : window.location.href;
                        }
                    });
                }
            });
        });

   
    </script>
    <script>
        $(document).ready(function () {
            $('#user_name').on('change', function () {
                var username = $(this).val();

                $.ajax({
                    url: '/api/checkUsernameAvailability',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ username: username }),
                    success: function (response) {
                        if (response.exists) {
                            $('#username-styling').attr('style', 'border: 2px solid red');
                            $('#create').prop('disabled', true);
                            iziToast.warning({
                                title: 'Warning',
                                message: `Username '${username}' not available`,
                                position: 'topRight',
                            });

                        } else if (username === "") {

                        }
                        else {
                            $('#username-styling').attr('style', 'border: 2px solid green');
                            $('#create').prop('disabled', false);
                        }
                    },
                    error: function (error) {
                        $('#result').text('Error checking user');
                    }
                });
            });
        });
    </script>
    <script type="text/javascript">
        flatpickr("#datetimepicker", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
        });
    </script>

    <!-- PDF Preview -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var $j = jQuery.noConflict();

        $j(document).ready(function () {
            var pdfDoc = null,
                pageNum = 1,
                pageRendering = false,
                pageNumPending = null,
                scale = 1.5,
                canvas = document.getElementById('pdfCanvas'),
                ctx = canvas.getContext('2d');

            function renderPage(num) {
                pageRendering = true;
                pdfDoc.getPage(num).then(function (page) {
                    var viewport = page.getViewport({ scale: scale });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    var renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };

                    var renderTask = page.render(renderContext);

                    renderTask.promise.then(function () {
                        pageRendering = false;

                        if (pageNumPending !== null) {
                            renderPage(pageNumPending);
                            pageNumPending = null;
                        }
                    });
                });

                document.getElementById('pageNum').textContent = num;
            }

            function queueRenderPage(num) {
                if (pageRendering) {
                    pageNumPending = num;
                } else {
                    renderPage(num);
                }
            }

            function onPrevPage() {
                if (pageNum <= 1) {
                    return;
                }
                pageNum--;
                queueRenderPage(pageNum);
            }

            function onNextPage() {
                if (pageNum >= pdfDoc.numPages) {
                    return;
                }
                pageNum++;
                queueRenderPage(pageNum);
            }

            $j('#prevPage').on('click', onPrevPage);
            $j('#nextPage').on('click', onNextPage);

            $j('.viewPdfButton').on('click', function () {
                $j('body').css('overflow', 'hidden');
                var fileType = $j(this).data('target');
                var fileInput = document.getElementById('file_paper');
                var file = fileInput.files[0];
                if (file && file.type === 'application/pdf') {
                    var fileURL = URL.createObjectURL(file);
                    pageNum = 1;
                    pageNumPending = null;
                    showPDF(fileURL);
                } else {
                    alert('Please upload a valid PDF file.');
                }
            });

            function showPDF(pdf_url) {
                pdfjsLib.getDocument(pdf_url).promise.then(function (pdfDoc_) {
                    pdfDoc = pdfDoc_;
                    document.getElementById('pageCount').textContent = pdfDoc.numPages;
                    renderPage(pageNum);
                    document.getElementById('pdfModal').style.display = 'block';
                });
            }

            function closeModal() {
                document.getElementById('pdfModal').style.display = 'none';
                $j('body').css('overflow', '');
            }

            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('closeFooterModal').addEventListener('click', closeModal);

            function checkFileSize(inputId) {
                var input = document.getElementById(inputId);
                var file = input.files[0];
                if (file.type !== 'application/pdf') {
                    iziToast.error({
                        title: 'Error',
                        message: 'Invalid file type. Please upload a PDF file.',
                        position: 'topRight',
                    });
                    event.target.value = '';
                    button.hide();
                    return;
                }
                var button = $j('.viewPdfButton[data-target="paper"]')
                button.show();
            }
            document.getElementById('file_paper').addEventListener('change', function (event) {
                checkFileSize('file_paper');
            });
        });
    </script>
</body>

</html>